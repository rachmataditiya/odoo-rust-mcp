name: Config Manager Tests

on:
  push:
    branches: [main]
    paths:
      - 'rust-mcp/src/config_manager/**'
      - 'rust-mcp/static/**'
      - '.github/workflows/config-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'rust-mcp/src/config_manager/**'
      - 'rust-mcp/static/**'

env:
  CARGO_TERM_COLOR: always
  RUST_LOG: debug

jobs:
  config-manager-tests:
    name: Config Manager Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust-mcp

      - name: Run config manager tests
        working-directory: rust-mcp
        run: |
          cargo test --lib config_manager -- --nocapture --test-threads=1

      - name: Test config file operations
        working-directory: rust-mcp
        run: |
          cargo test --lib config_manager::manager -- --nocapture

      - name: Test file watcher
        working-directory: rust-mcp
        run: |
          cargo test --lib config_manager::watcher -- --nocapture

      - name: Test config server
        working-directory: rust-mcp
        run: |
          cargo test --lib config_manager::server -- --nocapture

  integration-test:
    name: Config Server Integration Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust-mcp

      - name: Build project
        working-directory: rust-mcp
        run: cargo build --release

      - name: Setup test environment
        run: |
          mkdir -p /tmp/test-config
          cat > /tmp/test-config/instances.json <<EOF
          {
            "test": {
              "url": "http://localhost:8069",
              "db": "testdb",
              "apiKey": "test_key_12345"
            }
          }
          EOF
          
          cat > /tmp/test-config/server.json <<EOF
          {
            "serverName": "test-mcp",
            "instructions": "Test server"
          }
          EOF

      - name: Start config server (background)
        run: |
          ODOO_CONFIG_SERVER_PORT=3000 \
          RUST_LOG=info \
          timeout 60 /root/rust-mcp/target/release/rust-mcp \
            --transport http --listen 0.0.0.0:8787 &
          sleep 3

      - name: Test config API endpoints
        run: |
          # Wait for server to be ready
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -s http://127.0.0.1:3000/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            echo "Waiting for server... (attempt $((attempt+1))/$max_attempts)"
            sleep 1
            attempt=$((attempt+1))
          done
          
          # Test GET endpoints
          echo "Testing GET /api/config/instances..."
          curl -s http://127.0.0.1:3000/api/config/instances | jq .
          
          echo "Testing GET /api/config/server..."
          curl -s http://127.0.0.1:3000/api/config/server | jq .

      - name: Test HTML UI is served
        run: |
          echo "Testing GET / (UI)..."
          response=$(curl -s http://127.0.0.1:3000/)
          if echo "$response" | grep -q "Config Manager"; then
            echo "✓ UI is being served correctly"
          else
            echo "✗ UI not found"
            exit 1
          fi

  helm-validation:
    name: Helm Chart Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Lint Helm chart
        run: |
          helm lint helm/odoo-rust-mcp/

      - name: Template Helm chart
        run: |
          helm template odoo-mcp helm/odoo-rust-mcp/ \
            --values helm/odoo-rust-mcp/values.yaml \
            --set configServer.enabled=true \
            --set configServer.port=3000 \
            > /tmp/helm-output.yaml

      - name: Validate generated manifests
        run: |
          # Basic validation - file should not be empty
          if [ ! -s /tmp/helm-output.yaml ]; then
            echo "✗ Helm template output is empty"
            exit 1
          fi
          echo "✓ Helm template generated successfully"
          
          # Check that config server port is set
          if grep -q "ODOO_CONFIG_SERVER_PORT" /tmp/helm-output.yaml; then
            echo "✓ Config server port env var found"
          fi
          
          # Check that config-ui service port is defined
          if grep -q "config-ui" /tmp/helm-output.yaml; then
            echo "✓ Config UI service port found"
          fi

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./rust-mcp
          file: ./rust-mcp/Dockerfile
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
