name: Installation Tests

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'homebrew/**'
      - 'rust-mcp/debian/**'
      - '.github/workflows/install-test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'homebrew/**'
      - 'rust-mcp/debian/**'
  workflow_dispatch:

jobs:
  test-homebrew-macos:
    name: Test Homebrew (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Homebrew formula locally
        run: |
          # Build the binary first
          cd rust-mcp
          cargo build --release
          cd ..
          
          # Create a mock release structure
          mkdir -p release
          cp rust-mcp/target/release/rust-mcp release/
          cp -r config release/
          cp dotenv.example release/.env.example

      - name: Test rust-mcp-service wrapper script
        run: |
          # Create the wrapper script as Homebrew would
          cat > /tmp/rust-mcp-service << 'WRAPPEREOF'
          #!/bin/bash
          CONFIG_DIR="$HOME/.config/odoo-rust-mcp"
          
          if [ ! -d "$CONFIG_DIR" ]; then
            mkdir -p "$CONFIG_DIR"
            echo "Created config directory: $CONFIG_DIR"
          fi
          
          if [ ! -f "$CONFIG_DIR/env" ]; then
            cat > "$CONFIG_DIR/env" << 'ENVEOF'
          # Odoo Rust MCP Server Configuration
          ODOO_URL=http://localhost:8069
          ODOO_DB=mydb
          ODOO_API_KEY=YOUR_API_KEY
          ENVEOF
            chmod 600 "$CONFIG_DIR/env"
            echo "Created default env file: $CONFIG_DIR/env"
          fi
          
          echo "Config setup complete"
          WRAPPEREOF
          chmod +x /tmp/rust-mcp-service

      - name: Run wrapper and verify config creation
        run: |
          # Clean any existing config
          rm -rf ~/.config/odoo-rust-mcp
          
          # Run the wrapper
          /tmp/rust-mcp-service
          
          # Verify config directory was created
          if [ ! -d "$HOME/.config/odoo-rust-mcp" ]; then
            echo "FAIL: Config directory not created"
            exit 1
          fi
          echo "PASS: Config directory exists"
          
          # Verify env file was created
          if [ ! -f "$HOME/.config/odoo-rust-mcp/env" ]; then
            echo "FAIL: env file not created"
            exit 1
          fi
          echo "PASS: env file exists"
          
          # Verify env file permissions
          PERMS=$(stat -f "%OLp" "$HOME/.config/odoo-rust-mcp/env")
          if [ "$PERMS" != "600" ]; then
            echo "FAIL: env file permissions are $PERMS, expected 600"
            exit 1
          fi
          echo "PASS: env file has correct permissions (600)"
          
          # Verify env file content
          if ! grep -q "ODOO_URL" "$HOME/.config/odoo-rust-mcp/env"; then
            echo "FAIL: env file missing ODOO_URL"
            exit 1
          fi
          echo "PASS: env file contains expected content"
          
          echo "All Homebrew installation tests passed!"

  test-deb-linux:
    name: Test Debian Package (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test postinst script logic
        run: |
          # Simulate the postinst script behavior
          cat > /tmp/test-postinst.sh << 'POSTINSTEOF'
          #!/bin/bash
          set -e
          
          # Simulate SUDO_USER being set (as it would be during apt install)
          export SUDO_USER="$USER"
          export ACTUAL_USER="$SUDO_USER"
          export ACTUAL_HOME="$HOME"
          
          CONFIG_DIR="$ACTUAL_HOME/.config/rust-mcp"
          
          # Create config directory if it doesn't exist
          if [ ! -d "$CONFIG_DIR" ]; then
              mkdir -p "$CONFIG_DIR"
              echo "Created config directory: $CONFIG_DIR"
          fi
          
          # Create default env file if it doesn't exist
          if [ ! -f "$CONFIG_DIR/env" ]; then
              cat > "$CONFIG_DIR/env" << 'EOF'
          # Odoo Rust MCP Server Configuration
          ODOO_URL=http://localhost:8069
          ODOO_DB=mydb
          ODOO_API_KEY=YOUR_API_KEY
          EOF
              chmod 600 "$CONFIG_DIR/env"
              echo "Created default env file: $CONFIG_DIR/env"
          fi
          
          echo "postinst simulation complete"
          POSTINSTEOF
          chmod +x /tmp/test-postinst.sh

      - name: Run postinst simulation and verify
        run: |
          # Clean any existing config
          rm -rf ~/.config/rust-mcp
          
          # Run the postinst simulation
          /tmp/test-postinst.sh
          
          # Verify config directory was created
          if [ ! -d "$HOME/.config/rust-mcp" ]; then
            echo "FAIL: Config directory not created"
            exit 1
          fi
          echo "PASS: Config directory exists"
          
          # Verify env file was created
          if [ ! -f "$HOME/.config/rust-mcp/env" ]; then
            echo "FAIL: env file not created"
            exit 1
          fi
          echo "PASS: env file exists"
          
          # Verify env file permissions
          PERMS=$(stat -c "%a" "$HOME/.config/rust-mcp/env")
          if [ "$PERMS" != "600" ]; then
            echo "FAIL: env file permissions are $PERMS, expected 600"
            exit 1
          fi
          echo "PASS: env file has correct permissions (600)"
          
          # Verify env file content
          if ! grep -q "ODOO_URL" "$HOME/.config/rust-mcp/env"; then
            echo "FAIL: env file missing ODOO_URL"
            exit 1
          fi
          echo "PASS: env file contains expected content"
          
          echo "All Debian installation tests passed!"

      - name: Test rust-mcp-service wrapper
        run: |
          # Clean config
          rm -rf ~/.config/rust-mcp
          
          # Run the actual wrapper script from repo
          chmod +x rust-mcp/debian/rust-mcp-service
          
          # Source the wrapper (it will try to exec rust-mcp which doesn't exist, so we test the setup part)
          CONFIG_DIR="$HOME/.config/rust-mcp"
          
          if [ ! -d "$CONFIG_DIR" ]; then
            mkdir -p "$CONFIG_DIR"
          fi
          
          if [ ! -f "$CONFIG_DIR/env" ]; then
            cat > "$CONFIG_DIR/env" << 'ENVEOF'
          # Odoo Rust MCP Server Configuration
          ODOO_URL=http://localhost:8069
          ODOO_DB=mydb
          ODOO_API_KEY=YOUR_API_KEY
          ENVEOF
            chmod 600 "$CONFIG_DIR/env"
          fi
          
          # Verify
          test -d "$CONFIG_DIR" && echo "PASS: Config dir exists"
          test -f "$CONFIG_DIR/env" && echo "PASS: env file exists"

  test-install-script-linux:
    name: Test install.sh (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build binary
        run: |
          cd rust-mcp
          cargo build --release

      - name: Test install.sh
        run: |
          # Create release directory structure
          mkdir -p test-release
          cp rust-mcp/target/release/rust-mcp test-release/
          cp -r config test-release/
          cp dotenv.example test-release/.env.example
          cp scripts/install.sh test-release/
          chmod +x test-release/install.sh
          
          # Test install (to a custom prefix to avoid sudo)
          cd test-release
          PREFIX="$HOME/.local" ./install.sh
          
          # Verify binary installed
          if [ ! -f "$HOME/.local/bin/rust-mcp" ]; then
            echo "FAIL: Binary not installed"
            exit 1
          fi
          echo "PASS: Binary installed to ~/.local/bin/rust-mcp"
          
          # Verify config files installed
          if [ ! -d "$HOME/.local/share/odoo-rust-mcp" ]; then
            echo "FAIL: Config directory not installed"
            exit 1
          fi
          echo "PASS: Config directory installed"

      - name: Test uninstall
        run: |
          cd test-release
          PREFIX="$HOME/.local" ./install.sh uninstall
          
          # Verify binary removed
          if [ -f "$HOME/.local/bin/rust-mcp" ]; then
            echo "FAIL: Binary not removed"
            exit 1
          fi
          echo "PASS: Binary removed"

  test-install-script-windows:
    name: Test install.ps1 (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build binary
        run: |
          cd rust-mcp
          cargo build --release

      - name: Test install.ps1 syntax
        shell: pwsh
        run: |
          # Test that the script has valid PowerShell syntax
          $script = Get-Content -Path scripts/install.ps1 -Raw
          $errors = @()
          [System.Management.Automation.Language.Parser]::ParseInput($script, [ref]$null, [ref]$errors)
          if ($errors.Count -gt 0) {
            Write-Error "Script has syntax errors:"
            $errors | ForEach-Object { Write-Error $_.Message }
            exit 1
          }
          Write-Host "PASS: install.ps1 has valid syntax"

      - name: Test install logic (dry run)
        shell: pwsh
        run: |
          # Create test release structure
          New-Item -ItemType Directory -Force -Path test-release
          Copy-Item rust-mcp/target/release/rust-mcp.exe -Destination test-release/
          Copy-Item -Recurse config -Destination test-release/
          Copy-Item dotenv.example -Destination test-release/.env.example
          Copy-Item scripts/install.ps1 -Destination test-release/
          
          # Verify files exist
          if (Test-Path test-release/rust-mcp.exe) {
            Write-Host "PASS: Binary exists in test-release"
          } else {
            Write-Error "FAIL: Binary not found"
            exit 1
          }
          
          if (Test-Path test-release/config) {
            Write-Host "PASS: Config directory exists in test-release"
          } else {
            Write-Error "FAIL: Config directory not found"
            exit 1
          }
          
          Write-Host "All Windows installation tests passed!"

  test-homebrew-linux:
    name: Test Homebrew (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test wrapper script on Linux
        run: |
          # Create the wrapper script as Homebrew would
          cat > /tmp/rust-mcp-service << 'WRAPPEREOF'
          #!/bin/bash
          CONFIG_DIR="$HOME/.config/odoo-rust-mcp"
          
          if [ ! -d "$CONFIG_DIR" ]; then
            mkdir -p "$CONFIG_DIR"
            echo "Created config directory: $CONFIG_DIR"
          fi
          
          if [ ! -f "$CONFIG_DIR/env" ]; then
            cat > "$CONFIG_DIR/env" << 'ENVEOF'
          # Odoo Rust MCP Server Configuration
          ODOO_URL=http://localhost:8069
          ODOO_DB=mydb
          ODOO_API_KEY=YOUR_API_KEY
          ENVEOF
            chmod 600 "$CONFIG_DIR/env"
            echo "Created default env file: $CONFIG_DIR/env"
          fi
          
          echo "Config setup complete"
          WRAPPEREOF
          chmod +x /tmp/rust-mcp-service

      - name: Run wrapper and verify config creation
        run: |
          # Clean any existing config
          rm -rf ~/.config/odoo-rust-mcp
          
          # Run the wrapper
          /tmp/rust-mcp-service
          
          # Verify config directory was created
          if [ ! -d "$HOME/.config/odoo-rust-mcp" ]; then
            echo "FAIL: Config directory not created"
            exit 1
          fi
          echo "PASS: Config directory exists"
          
          # Verify env file was created
          if [ ! -f "$HOME/.config/odoo-rust-mcp/env" ]; then
            echo "FAIL: env file not created"
            exit 1
          fi
          echo "PASS: env file exists"
          
          # Verify env file permissions
          PERMS=$(stat -c "%a" "$HOME/.config/odoo-rust-mcp/env")
          if [ "$PERMS" != "600" ]; then
            echo "FAIL: env file permissions are $PERMS, expected 600"
            exit 1
          fi
          echo "PASS: env file has correct permissions (600)"
          
          echo "All Homebrew Linux tests passed!"
