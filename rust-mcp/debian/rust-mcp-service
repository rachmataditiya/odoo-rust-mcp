#!/bin/bash
# Wrapper script for rust-mcp that loads user configuration
# This script is used by systemd service and can be run directly

CONFIG_DIR="$HOME/.config/rust-mcp"

# Create config directory if it doesn't exist
if [ ! -d "$CONFIG_DIR" ]; then
    mkdir -p "$CONFIG_DIR"
    echo "Created config directory: $CONFIG_DIR"
fi

# Create instances.json for multi-instance configuration
if [ ! -f "$CONFIG_DIR/instances.json" ]; then
    cat > "$CONFIG_DIR/instances.json" << 'INSTANCESEOF'
{
  "production": {
    "url": "http://localhost:8069",
    "db": "production",
    "apiKey": "YOUR_ODOO_19_API_KEY"
  },
  "staging": {
    "url": "http://localhost:8069",
    "db": "staging",
    "apiKey": "YOUR_STAGING_API_KEY"
  },
  "development": {
    "url": "http://localhost:8069",
    "db": "development",
    "version": "18",
    "username": "admin",
    "password": "admin"
  }
}
INSTANCESEOF
    chmod 600 "$CONFIG_DIR/instances.json"
    echo "Created default instances.json: $CONFIG_DIR/instances.json"
    echo "Please edit it with your Odoo credentials"
fi

# Create default env file if it doesn't exist
if [ ! -f "$CONFIG_DIR/env" ]; then
    cat > "$CONFIG_DIR/env" << ENVEOF
# Odoo Rust MCP Server Configuration
# Multi-instance configuration (default)

# =============================================================================
# Multi-Instance Configuration (Default - Recommended)
# =============================================================================
# Uses instances.json for multiple Odoo instances
ODOO_INSTANCES_JSON=$CONFIG_DIR/instances.json

# =============================================================================
# Single Instance Configuration (Alternative - uncomment if not using multi-instance)
# =============================================================================
# # Odoo 19+ (API Key authentication)
# ODOO_URL=http://localhost:8069
# ODOO_DB=mydb
# ODOO_API_KEY=YOUR_API_KEY
#
# # Odoo < 19 (Username/Password authentication)
# # ODOO_VERSION=18
# # ODOO_USERNAME=admin
# # ODOO_PASSWORD=admin

# =============================================================================
# Config UI Authentication
# =============================================================================
# Login credentials for the config web UI
# IMPORTANT: Change these default credentials!
CONFIG_UI_USERNAME=admin
CONFIG_UI_PASSWORD=changeme

# =============================================================================
# MCP HTTP Transport Authentication
# =============================================================================
# Enable/disable HTTP authentication (default: false)
MCP_AUTH_ENABLED=false
# Generate a secure token: openssl rand -hex 32
# MCP_AUTH_TOKEN=your-secure-random-token-here

# =============================================================================
# MCP Config Paths
# =============================================================================
# Path to MCP configuration files (tools, prompts, server settings)
MCP_TOOLS_JSON=$CONFIG_DIR/tools.json
MCP_PROMPTS_JSON=$CONFIG_DIR/prompts.json
MCP_SERVER_JSON=$CONFIG_DIR/server.json
ENVEOF
    chmod 600 "$CONFIG_DIR/env"
    echo "Created default env file: $CONFIG_DIR/env"
else
    # Migration: Add MCP config paths to existing env file if missing
    if ! grep -q "MCP_TOOLS_JSON" "$CONFIG_DIR/env"; then
        echo "Migration: Adding MCP config paths to env file..."
        cat >> "$CONFIG_DIR/env" << MIGRATEEOF

# =============================================================================
# MCP Config Paths (added in v0.3.27)
# =============================================================================
# Path to MCP configuration files (tools, prompts, server settings)
MCP_TOOLS_JSON=$CONFIG_DIR/tools.json
MCP_PROMPTS_JSON=$CONFIG_DIR/prompts.json
MCP_SERVER_JSON=$CONFIG_DIR/server.json
MIGRATEEOF
        echo "Migration complete"
    fi
fi

# Copy default config files to user directory if they don't exist
for config_file in tools.json prompts.json server.json; do
    if [ ! -f "$CONFIG_DIR/$config_file" ] && [ -f "/usr/share/rust-mcp/$config_file" ]; then
        cp "/usr/share/rust-mcp/$config_file" "$CONFIG_DIR/$config_file"
        chmod 600 "$CONFIG_DIR/$config_file"
        echo "Copied default $config_file to: $CONFIG_DIR/$config_file"
    fi
done

# Load environment from user config if exists
if [ -f "$CONFIG_DIR/env" ]; then
    set -a
    source "$CONFIG_DIR/env"
    set +a
fi

# Set default MCP config paths to user config dir (fallback to share dir)
export MCP_TOOLS_JSON="${MCP_TOOLS_JSON:-$CONFIG_DIR/tools.json}"
export MCP_PROMPTS_JSON="${MCP_PROMPTS_JSON:-$CONFIG_DIR/prompts.json}"
export MCP_SERVER_JSON="${MCP_SERVER_JSON:-$CONFIG_DIR/server.json}"

# Set default instances.json path if not already set
export ODOO_INSTANCES_JSON="${ODOO_INSTANCES_JSON:-$CONFIG_DIR/instances.json}"

exec /usr/bin/rust-mcp "$@"
